import{d as ha,c as r,b as a,g as h,w as u,k as _a,e as V,h as _,F as L,p,r as c,s as $,i as xa,u as U,o,a as E,m as Ca,f as Ta,v as g,j as I,n as w,t as f,x as aa,l as ja}from"./runtime-dom.esm-bundler.CUj3j_Ug.js";import{S as x}from"./sweetalert2.esm.all.NNS-RXd7.js";import{u as Pa,B as Sa,T as Va,a as La}from"./usePagination.CClfIzvj.js";import{s as Ua,C as Ba}from"./default.PTKVnp7l.js";import{_ as Na}from"./_plugin-vue_export-helper.DlAUqK2U.js";const Fa=ha({__name:"permohonan",props:{level:{},idUnitKerja:{},apiUrl:{}},setup(M,{expose:t}){t();const A=p(()=>e.level==="3"||e.level==="2"),e=M,y=c([]),B=c([]),l=c([]),k=c(!1),K=c(!1),z=c("Tambah Permohonan"),G=c(""),R=c(""),O=c(""),J=e.apiUrl,Y=i=>i?/^https?:\/\//i.test(i)?i:`${J}/storage/${i}`:"",b=c({id:null,tiket:"",judul:"",lokasi_kejadian:"",deskripsi:"",keterangan:"",nama_penduduk:"",id_layanan:null,layanan:"",tingkat_urgensi:"",tingkat_rahasia:"",status_laporan:"",bukti:""}),N=c("semua"),ta=c(!1),ea=[{key:"semua",label:"Semua"},{key:"masuk",label:"Masuk"},{key:"diverifikasi",label:"Diverifikasi"},{key:"diproses",label:"Diproses"},{key:"ditanggapi",label:"Ditanggapi"},{key:"selesai",label:"Selesai"}],C=i=>{const n=(i??"").toLowerCase().trim();return n?n.includes("verifikasi")?"diverifikasi":n.includes("proses")?"diproses":n.includes("tanggapi")?"ditanggapi":n.includes("selesai")?"selesai":n.includes("masuk")?"masuk":n:""},la=p(()=>{const i={semua:y.value.length,masuk:0,diverifikasi:0,diproses:0,ditanggapi:0,selesai:0};return y.value.forEach(n=>{const s=C(n.status_laporan);s&&s in i&&(i[s]+=1)}),i}),H=p(()=>N.value==="semua"?y.value:y.value.filter(i=>C(i.status_laporan)===N.value)),{page:ia,pageSize:na,totalPages:sa,pageStartIndex:oa,pagedItems:T,pages:ra,goFirst:da,goPrev:ua,goNext:ca,goLast:ma,goTo:ga}=Pa(H,{pageSize:10}),F=c(null),Q=p(()=>{const i=b.value.id_layanan;return i==null?"":l.value.find(s=>Number(s.id)===Number(i))?.nama??""});$(Q,i=>{b.value.layanan=i},{immediate:!0}),$(()=>b.value.status_laporan,i=>{i!=="Ditolak"&&(b.value.keterangan="")});const D=p(()=>{const s=((b.value.bukti||"").split("#")[0]?.split("?")[0]??"").split(".");return s.length<2?"":(s.pop()||"").toLowerCase()}),ka=p(()=>{const i=D.value;return["jpg","jpeg","png","gif","webp","bmp","svg"].includes(i)}),pa=p(()=>D.value==="pdf");xa(async()=>{j(),await W(),await U(),await X()});async function j(i="",n="",s=""){k.value=!0;try{const d=new URL("/api/backend/riwayat",window.location.origin);s&&d.searchParams.set("search",s),n&&(d.searchParams.set("sampai_tanggal",n),d.searchParams.set("dari_tanggal",i)),d.searchParams.set("id_unit_kerja",String(e.idUnitKerja)),d.searchParams.set("page","permohonan");const m=await fetch(d.toString(),{credentials:"include"});if(!m.ok)throw new Error(await m.text());const v=await m.json();y.value=(Array.isArray(v)?v:[]).map(S=>({...S,selected:!!S.selected}))}catch(d){console.error("Gagal memuat data pengaduan:",d)}finally{k.value=!1}}async function W(){try{const i=new URL("/api/backend/penduduk",window.location.origin),n=await fetch(i.toString(),{credentials:"include"});if(!n.ok)throw new Error(await n.text());const s=await n.json();B.value=Array.isArray(s)?s:s?.data??[],await U()}catch(i){console.error("Gagal memuat data pengaduan:",i)}}async function X(){try{const i=new URL("/api/backend/layanan",window.location.origin),n=await fetch(i.toString(),{credentials:"include"});if(!n.ok)throw new Error(await n.text());const s=await n.json(),d=Array.isArray(s)?s:s?.data??[];l.value=d.map(m=>({...m,id:m?.id!==void 0&&m?.id!==null?Number(m.id):m?.id})),await U()}catch(i){console.error("Gagal memuat data pengaduan:",i)}}function fa(){j(R.value.trim(),O.value.trim(),G.value.trim())}function Z(){F?.value?.show()}function ya(){F?.value?.hide()}async function ba(i){z.value="Detail Permohonan",b.value={id:null,tiket:"",judul:"",id_layanan:null,layanan:"",nama_penduduk:"",lokasi_kejadian:"",deskripsi:"",keterangan:"",tingkat_urgensi:"",tingkat_rahasia:"",status_laporan:"",bukti:""},Z();try{const n=await fetch(`/api/backend/riwayat?id=${i}?&page=permohonan`,{method:"GET",credentials:"include"});if(!n.ok)throw new Error(await n.text());const s=await n.json();b.value={id:s.id,nama_penduduk:s.nama,tiket:s.tiket||"",judul:s.judul||"",id_layanan:s.id_layanan!==void 0&&s.id_layanan!==null?Number(s.id_layanan):null,layanan:"",lokasi_kejadian:s.lokasi_kejadian||"",deskripsi:s.deskripsi||"",keterangan:s.keterangan||"",tingkat_urgensi:s.tingkat_urgensi||"",tingkat_rahasia:s.tingkat_rahasia||"",status_laporan:s.status_laporan||"",bukti:Y(s.bukti)},await U()}catch(n){console.error("Gagal memuat detail:",n),x.fire({icon:"error",title:"Oops",text:"Gagal memuat detail."})}}const va=p({get(){return T.value.length>0&&T.value.every(i=>!!i.selected)},set(i){T.value.forEach(n=>{n.selected=i})}}),P=p(()=>y.value.filter(i=>!!i.selected).map(i=>i.id));async function wa(i="menghapus"){if(P.value.length===0){await x.fire({icon:"warning",title:"Peringatan",text:"Belum ada data yang dipilih."});return}const n=i==="pulihkan",s=n?"memulihkan":"menghapus",d=n?"pulihkan":"hapus";if((await x.fire({icon:"warning",title:"Peringatan",text:`Anda yakin ingin ${s} ${P.value.length} data terpilih?`,showCancelButton:!0,confirmButtonText:`Ya, ${d}`,cancelButtonText:"Tidak"})).isConfirmed)try{const v=await fetch("/api/backend/riwayat",{method:"DELETE",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:i,page:"permohonan",ids:P.value})}),S=await v.json().catch(()=>({}));if(!v.ok)throw new Error(S?.message||"Gagal memproses data terpilih.");await x.fire({icon:"success",title:"Berhasil",text:n?"Data terpilih berhasil dipulihkan.":"Data terpilih berhasil dihapus."}),await j()}catch(v){console.error("Gagal menghapus data terpilih:",v),await x.fire({icon:"error",title:"Oops",text:n?"Gagal memulihkan data terpilih.":"Gagal menghapus data terpilih."})}}const q={isSuperAdmin:A,props:e,items:y,dataPenduduk:B,dataLayanan:l,loading:k,isSaving:K,modalTitle:z,search:G,dari_tanggal:R,sampai_tanggal:O,api_url:J,resolveBuktiUrl:Y,form:b,statusFilter:N,showFilters:ta,statusOptions:ea,normalizeStatus:C,statusCounts:la,filteredItems:H,page:ia,pageSize:na,totalPages:sa,pageStartIndex:oa,pagedItems:T,pages:ra,goFirst:da,goPrev:ua,goNext:ca,goLast:ma,goTo:ga,modalRef:F,selectedLayananLabel:Q,buktiExtension:D,buktiIsImage:ka,buktiIsPdf:pa,fetchList:j,pendudukList:W,layananList:X,doSearch:fa,showModal:Z,hideModal:ya,openEdit:ba,allVisibleSelected:va,selectedIds:P,hapusTerpilih:wa,config:{dateFormat:"d-m-Y",allowInput:!0},formatDateTime:i=>{const n=i.tanggal||"",s=i.waktu||"";return!n&&!s?"-":[n,s].filter(Boolean).join(" ")},getInitials:i=>{const n=(i??"").trim();if(!n)return"-";const s=n.split(/\s+/).filter(Boolean),d=s[0]?.[0]??"",m=s.length>1?s[s.length-1]?.[0]??"":"";return(d+m).toUpperCase()},statusBadgeClass:i=>{const n=C(i);return n?`status-${n}`:"status-semua"},Button:La,TableCard:Va,BaseModal:Sa,get FlatPickr(){return Ba},get Multiselect(){return Ua}};return Object.defineProperty(q,"__isScriptSetup",{enumerable:!1,value:!0}),q}}),Da={class:"riwayat-shell"},Ea={class:"riwayat-header"},Ia={class:"riwayat-header-actions"},Ma={class:"riwayat-page-size"},Aa={class:"riwayat-bulk-actions"},Ka={class:"riwayat-card"},za={class:"riwayat-panel"},Ga={class:"riwayat-toolbar"},Ra={class:"riwayat-search"},Oa=["onKeydown"],Ja={class:"riwayat-toolbar-actions"},Ya={key:0,class:"riwayat-filter-panel"},Ha={class:"riwayat-statuses"},Qa=["onClick"],Wa={class:"count"},Xa={class:"riwayat-table-wrap"},Za={class:"riwayat-table"},qa={class:"riwayat-col-checkbox"},$a={class:"riwayat-col-checkbox"},at=["value","onUpdate:modelValue"],tt={class:"riwayat-col-ticket"},et={class:"riwayat-ticket"},lt={class:"riwayat-user"},it={class:"riwayat-avatar"},nt={class:"riwayat-name"},st={class:"riwayat-issue"},ot={class:"riwayat-date"},rt={class:"text-end"},dt=["onClick"],ut={key:1},ct={class:"mt-3",style:{"overflow-x":"auto","-webkit-overflow-scrolling":"touch","scrollbar-width":"none",width:"100%"}},mt={class:"d-flex justify-content-end","aria-label":"Pagination"},gt={class:"pagination mb-0 flex-nowrap",style:{"white-space":"nowrap","min-width":"max-content"}},kt=["disabled"],pt=["disabled"],ft=["onClick"],yt={key:1,class:"page-link text-muted","aria-hidden":"true",style:{"pointer-events":"none",cursor:"default"}},bt=["disabled"],vt=["disabled"],wt={class:"row"},ht={class:"col-md-6 mb-2"},_t=["value"],xt={class:"col-md-6 mb-2"},Ct={class:"col-md-6 mb-2"},Tt={class:"col-md-6 mb-2"},jt={class:"col-md-6 mb-2"},Pt={class:"col-md-6 mb-2"},St={class:"col-md-6 mb-2"},Vt={class:"col-md-6 mb-2"},Lt={key:0,class:"col-md-12 mb-2"},Ut={key:1,class:"col-md-12 mb-2"},Bt=["src"],Nt={key:1,class:"ratio ratio-16x9"},Ft=["src"],Dt=["href"],Et={class:"col-md-12 mb-2"};function It(M,t,A,e,y,B){return o(),r(L,null,[a("div",Da,[a("div",Ea,[t[26]||(t[26]=a("div",null,[a("h2",{class:"riwayat-title"},"Riwayat Permohonan")],-1)),a("div",Ia,[a("div",Ma,[u(a("select",{"onUpdate:modelValue":t[0]||(t[0]=l=>e.pageSize=l),"aria-label":"Jumlah entri per halaman"},[...t[22]||(t[22]=[a("option",{value:"10"},"10",-1),a("option",{value:"25"},"25",-1),a("option",{value:"50"},"50",-1),a("option",{value:"100"},"100",-1)])],512),[[_a,e.pageSize,void 0,{number:!0}]]),t[23]||(t[23]=a("span",null,"entri per halaman",-1)),t[24]||(t[24]=a("i",{class:"ti ti-chevron-down"},null,-1))]),a("div",Aa,[a("button",{type:"button",class:"riwayat-action-btn riwayat-delete",onClick:t[1]||(t[1]=l=>e.hapusTerpilih("menghapus"))},[...t[25]||(t[25]=[a("i",{class:"ti ti-trash"},null,-1),V(" Hapus ",-1)])])])])]),a("div",Ka,[h(e.TableCard,{loading:e.loading,isEmpty:!1,title:""},{default:_(()=>[a("div",za,[a("div",Ga,[a("div",Ra,[t[27]||(t[27]=a("i",{class:"ti ti-search"},null,-1)),u(a("input",{type:"text",name:"cari_pengaduan",placeholder:"Cari berdasarkan nomor tiket atau kata kunci...","onUpdate:modelValue":t[2]||(t[2]=l=>e.search=l),onKeydown:Ca(Ta(e.doSearch,["prevent"]),["enter"])},null,40,Oa),[[g,e.search,void 0,{trim:!0}]])]),a("div",Ja,[a("button",{type:"button",class:"riwayat-filter-btn",onClick:t[3]||(t[3]=l=>e.showFilters=!e.showFilters)},[...t[28]||(t[28]=[a("i",{class:"ti ti-filter"},null,-1),V(" Filter ",-1),a("i",{class:"ti ti-chevron-down"},null,-1)])])])]),e.showFilters?(o(),r("div",Ya,[h(e.FlatPickr,{modelValue:e.dari_tanggal,"onUpdate:modelValue":t[4]||(t[4]=l=>e.dari_tanggal=l),class:"riwayat-input",placeholder:"Dari tanggal",config:e.config},null,8,["modelValue"]),h(e.FlatPickr,{modelValue:e.sampai_tanggal,"onUpdate:modelValue":t[5]||(t[5]=l=>e.sampai_tanggal=l),class:"riwayat-input",placeholder:"Sampai tanggal",config:e.config},null,8,["modelValue"]),a("button",{type:"button",class:"riwayat-action-btn riwayat-apply",onClick:e.doSearch},[...t[29]||(t[29]=[a("i",{class:"ti ti-search"},null,-1),V(" Terapkan ",-1)])])])):E("",!0),a("div",Ha,[(o(),r(L,null,I(e.statusOptions,l=>a("button",{key:l.key,type:"button",class:w(["riwayat-status-pill",["status-"+l.key,{active:e.statusFilter===l.key}]]),onClick:k=>e.statusFilter=l.key},[a("span",null,f(l.label),1),a("span",Wa,f(e.statusCounts[l.key]??0),1)],10,Qa)),64))]),a("div",Xa,[a("table",Za,[a("thead",null,[a("tr",null,[a("th",qa,[u(a("input",{type:"checkbox",class:"form-check-input","onUpdate:modelValue":t[6]||(t[6]=l=>e.allVisibleSelected=l)},null,512),[[aa,e.allVisibleSelected]])]),t[30]||(t[30]=a("th",null,"No. Tiket",-1)),t[31]||(t[31]=a("th",null,"Pelapor",-1)),t[32]||(t[32]=a("th",null,"Layanan / Pengaduan",-1)),t[33]||(t[33]=a("th",null,"Status",-1)),t[34]||(t[34]=a("th",null,"Tanggal",-1)),t[35]||(t[35]=a("th",{class:"text-end"},"Aksi",-1))])]),a("tbody",null,[e.pagedItems.length?(o(!0),r(L,{key:0},I(e.pagedItems,l=>(o(),r("tr",{key:l.id},[a("td",$a,[u(a("input",{type:"checkbox",class:"form-check-input",value:l.id,"onUpdate:modelValue":k=>l.selected=k},null,8,at),[[aa,l.selected]])]),a("td",tt,[a("div",et,f(l.tiket),1)]),a("td",null,[a("div",lt,[a("div",it,f(e.getInitials(l.nama)),1),a("div",nt,f(l.nama),1)])]),a("td",st,f(l.judul),1),a("td",null,[a("span",{class:w(["riwayat-badge",e.statusBadgeClass(l.status_laporan)])},f(l.status_laporan||"-"),3)]),a("td",ot,f(e.formatDateTime(l)),1),a("td",rt,[a("button",{type:"button",class:"riwayat-action-icon",onClick:k=>e.openEdit(l.id)},[...t[36]||(t[36]=[a("i",{class:"ti ti-eye"},null,-1)])],8,dt)])]))),128)):(o(),r("tr",ut,[...t[37]||(t[37]=[a("td",{colspan:"7",class:"text-center text-muted py-4"},"Tidak ada data",-1)])]))])])]),a("div",ct,[a("nav",mt,[a("ul",gt,[a("li",{class:w(["page-item",{disabled:e.page===1}])},[a("button",{type:"button",class:"page-link",onClick:t[7]||(t[7]=(...l)=>e.goFirst&&e.goFirst(...l)),disabled:e.page===1},"«",8,kt)],2),a("li",{class:w(["page-item",{disabled:e.page===1}])},[a("button",{type:"button",class:"page-link",onClick:t[8]||(t[8]=(...l)=>e.goPrev&&e.goPrev(...l)),disabled:e.page===1},"‹",8,pt)],2),(o(!0),r(L,null,I(e.pages,(l,k)=>(o(),r("li",{key:"p-"+k,class:w(["page-item",{active:l===e.page}])},[l!==null?(o(),r("button",{key:0,type:"button",class:"page-link",onClick:K=>e.goTo(l)},f(l),9,ft)):(o(),r("span",yt,"…"))],2))),128)),a("li",{class:w(["page-item",{disabled:e.page===e.totalPages}])},[a("button",{type:"button",class:"page-link",onClick:t[9]||(t[9]=(...l)=>e.goNext&&e.goNext(...l)),disabled:e.page===e.totalPages},"›",8,bt)],2),a("li",{class:w(["page-item",{disabled:e.page===e.totalPages}])},[a("button",{type:"button",class:"page-link",onClick:t[10]||(t[10]=(...l)=>e.goLast&&e.goLast(...l)),disabled:e.page===e.totalPages},"»",8,vt)],2)])])])])]),_:1},8,["loading"])])]),h(e.BaseModal,{title:e.modalTitle,ref:"modalRef"},{closeButton:_(()=>[a("button",{type:"button",class:"btn-close","aria-label":"Close",onClick:e.hideModal})]),formModal:_(()=>[a("form",wt,[a("div",ht,[t[38]||(t[38]=a("label",{class:"form-label"},"No Tiket",-1)),u(a("input",{type:"text",class:"form-control",placeholder:"No Tiket",disabled:!0,"onUpdate:modelValue":t[11]||(t[11]=l=>e.form.tiket=l)},null,512),[[g,e.form.tiket,void 0,{trim:!0}]]),a("input",{type:"hidden",value:e.form.id??""},null,8,_t)]),a("div",xt,[t[39]||(t[39]=a("label",{class:"form-label"},"Nama",-1)),u(a("input",{type:"text",class:"form-control",placeholder:"No Tiket",disabled:!0,"onUpdate:modelValue":t[12]||(t[12]=l=>e.form.nama_penduduk=l)},null,512),[[g,e.form.nama_penduduk,void 0,{trim:!0}]])]),a("div",Ct,[t[40]||(t[40]=a("label",{class:"form-label"},"Layanan",-1)),e.isSuperAdmin?(o(),ja(e.Multiselect,{key:0,id:"id_layanan",class:"multiselect-form",modelValue:e.form.id_layanan,"onUpdate:modelValue":t[13]||(t[13]=l=>e.form.id_layanan=l),options:e.dataLayanan,"value-prop":"id",label:"nama",searchable:!0,placeholder:"Pilih layanan",disabled:!0},null,8,["modelValue","options"])):u((o(),r("input",{key:1,type:"text",class:"form-control",placeholder:"No Tiket",disabled:!0,"onUpdate:modelValue":t[14]||(t[14]=l=>e.form.layanan=l)},null,512)),[[g,e.form.layanan,void 0,{trim:!0}]])]),a("div",Tt,[t[41]||(t[41]=a("label",{class:"form-label"},"Judul",-1)),u(a("input",{type:"text",class:"form-control",disabled:"",placeholder:"Judul","onUpdate:modelValue":t[15]||(t[15]=l=>e.form.judul=l)},null,512),[[g,e.form.judul,void 0,{trim:!0}]])]),a("div",jt,[t[42]||(t[42]=a("label",{class:"form-label"},"Lokasi Kejadian",-1)),u(a("input",{type:"text",class:"form-control",disabled:"",placeholder:"Lokasi Kejadian","onUpdate:modelValue":t[16]||(t[16]=l=>e.form.lokasi_kejadian=l)},null,512),[[g,e.form.lokasi_kejadian,void 0,{trim:!0}]])]),a("div",Pt,[t[43]||(t[43]=a("label",{class:"form-label"},"Tingkat Urgensi",-1)),u(a("input",{type:"text",class:"form-control",disabled:"",placeholder:"Lokasi Kejadian","onUpdate:modelValue":t[17]||(t[17]=l=>e.form.tingkat_urgensi=l)},null,512),[[g,e.form.tingkat_urgensi,void 0,{trim:!0}]])]),a("div",St,[t[44]||(t[44]=a("label",{class:"form-label"},"Tingkat Kerahasiaan",-1)),u(a("input",{type:"text",class:"form-control",disabled:"",placeholder:"Lokasi Kejadian","onUpdate:modelValue":t[18]||(t[18]=l=>e.form.tingkat_rahasia=l)},null,512),[[g,e.form.tingkat_rahasia,void 0,{trim:!0}]])]),a("div",Vt,[t[45]||(t[45]=a("label",{class:"form-label"},"Status Laporan",-1)),u(a("input",{type:"text",class:"form-control",disabled:"",placeholder:"Lokasi Kejadian","onUpdate:modelValue":t[19]||(t[19]=l=>e.form.status_laporan=l)},null,512),[[g,e.form.status_laporan,void 0,{trim:!0}]])]),e.form.status_laporan==="Ditolak"?(o(),r("div",Lt,[t[46]||(t[46]=a("label",{class:"form-label"},"Keterangan Penolakan",-1)),u(a("textarea",{type:"text",disabled:"",class:"form-control",placeholder:"Tulis alasan penolakan...","onUpdate:modelValue":t[20]||(t[20]=l=>e.form.keterangan=l)},null,512),[[g,e.form.keterangan,void 0,{trim:!0}]])])):E("",!0),e.form.bukti!==""?(o(),r("div",Ut,[t[47]||(t[47]=a("label",{class:"form-label"},"Lampiran Bukti",-1)),e.buktiIsImage?(o(),r("img",{key:0,src:e.form.bukti,alt:"Lampiran bukti",class:"img-fluid d-flex",loading:"lazy",width:"60%"},null,8,Bt)):e.buktiIsPdf?(o(),r("div",Nt,[a("iframe",{src:e.form.bukti,title:"Lampiran bukti PDF",loading:"lazy",width:"50%"},null,8,Ft)])):(o(),r("a",{key:2,href:e.form.bukti,target:"_blank",rel:"noopener",class:"text-decoration-underline"}," Lihat lampiran ",8,Dt))])):E("",!0),a("div",Et,[t[48]||(t[48]=a("label",{class:"form-label"},"Uraian",-1)),u(a("textarea",{type:"text",class:"form-control",disabled:!0,placeholder:"Uraian","onUpdate:modelValue":t[21]||(t[21]=l=>e.form.deskripsi=l)},null,512),[[g,e.form.deskripsi,void 0,{trim:!0}]])])])]),footerModal:_(()=>[h(e.Button,{class:"btn bg-danger-subtle text-danger",onClick:e.hideModal},{default:_(()=>[...t[49]||(t[49]=[V("Tutup",-1)])]),_:1})]),_:1},8,["title"])],64)}const Ht=Na(Fa,[["render",It]]);export{Ht as default};
