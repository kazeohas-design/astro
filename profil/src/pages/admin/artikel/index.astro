---
import LayoutBackend from "../../../layout/LayoutBackend.astro";
import { getPagination } from "../../../helper/pagination";
import Pagination from "../../../component/pagination.astro";

const url = import.meta.env.AUTH_BASE_URL;
const res = await fetch(new URL("/controller/artikel", Astro.request.url), {
  headers: {
    cookie: Astro.request.headers.get("cookie") ?? "",
  },
});

console.log(res);
// if (!res.ok) {
//   return Astro.redirect("/log_profil");
// }

const dataArtikel = (await res.json().catch(() => null)) ?? [];

const resKategori = await fetch(
  new URL("/controller/kategori", Astro.request.url),
  {
    headers: {
      cookie: Astro.request.headers.get("cookie") ?? "",
    },
  }
);

if (!resKategori.ok) {
  return Astro.redirect("/log_profil");
}

const dataKategori = await resKategori.json();

const pagination = getPagination(Astro.url, dataArtikel.length, 10);

const paginatedArtikel = dataArtikel.slice(
  pagination.start,
  pagination.start + pagination.perPage
);
---

<LayoutBackend title="Artikel">
  <div class="card w-100 position-relative overflow-hidden">
    <div
      class="px-4 py-3 border-bottom d-flex justify-content-between align-items-center"
    >
      <h5 class="mb-0">Artikel</h5>

      <div class="d-flex gap-2">
        <button type="button" class="btn btn-primary" onclick="tambah(event)">
          <i class="ti ti-plus"></i> Tambah
        </button>
      </div>
    </div>

    <div class="card-body">
      <div class="row gy-2 align-items-center mb-3">
        <div
          class="col-12 col-md-auto d-flex flex-column flex-sm-row align-items-stretch align-items-sm-center justify-content-center justify-content-md-start gap-2"
        >
          <label for="zero_config_length" class="mb-0 text-nowrap">
            Tampilkan
          </label>
          <select
            name="zero_config_length"
            id="zero_config_length"
            class="form-select flex-grow-1 flex-sm-grow-0"
          >
            <option value="10" selected={pagination.perPage === 10}>10</option>
            <option value="25" selected={pagination.perPage === 25}>25</option>
            <option value="50" selected={pagination.perPage === 50}>50</option>
            <option value="100" selected={pagination.perPage === 100}
              >100</option
            >
          </select>
        </div>

        <div class="col-12 col-md-3 ms-md-auto">
          <input
            type="text"
            name="cari_kategori"
            placeholder="Cari Artikel ..."
            class="form-control w-100"
          />
        </div>
      </div>
      <div class="table-responsive border rounded-4">
        <table class="table text-nowrap mb-0 align-middle" id="page">
          <thead class="bg-primary text-white">
            <tr>
              <th>No</th>
              <th>Judul</th>
              <th>Status</th>
              <th>Gambar</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody id="artikel-table">
            {
              (paginatedArtikel.length > 0 &&
                paginatedArtikel.map((item: any, index: number) => {
                  const no = pagination.start + index;
                  const detail = encodeURIComponent(JSON.stringify(item));

                  return (
                    <tr>
                      <td>{no + 1}</td>
                      <td>
                        {item.judul} <br />{" "}
                        <span class="badge bg-success">{item.kategori}</span>
                      </td>
                      <td>{item.status}</td>
                      <td>
                        <img
                          width="100"
                          src={`${url}/storage/${item.gambar}`}
                          alt=""
                        />
                      </td>
                      <td>
                        <button
                          type="button"
                          onclick={`edit('${detail}')`}
                          class="btn btn-primary me-1"
                        >
                          <i class="ti ti-edit fs-5" />
                        </button>
                        <button
                          type="button"
                          class="btn btn-danger"
                          onclick={`hapus(${JSON.stringify(item.id)})`}
                        >
                          <i class="ti ti-trash fs-5" />
                        </button>
                      </td>
                    </tr>
                  );
                })) || (
                <tr>
                  <td colspan="5" class="text-center">
                    Tidak ada data
                  </td>
                </tr>
              )
            }
          </tbody>
        </table>
      </div>
      <Pagination pagination={pagination} />
    </div>
  </div>

  <div
    class="modal fade"
    id="tambah-artikel"
    tabindex="-1"
    aria-labelledby="bs-example-modal-lg"
    aria-hidden="true"
  >
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header d-flex align-items-center">
          <h4 class="modal-title" id="myLargeModalLabel">Tambah Artikel</h4>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="form-artikel">
            <div class="mb-3">
              <label class="form-label">Judul</label>
              <div class="input-group">
                <span class="input-group-text px-6" id="basic-addon1">
                  <i class="ti ti-category fs-6"></i>
                </span>
                <input
                  type="hidden"
                  name="id_artikel"
                  class="form-control"
                  id="id_artikel"
                />
                <input
                  type="hidden"
                  name="oldImage"
                  class="form-control"
                  id="oldImage"
                />
                <input
                  type="text"
                  class="form-control ps-2"
                  name="judul"
                  id="judul"
                  placeholder="Judul..."
                />
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Kategori</label>
              <div class="input-group">
                <span class="input-group-text px-6" id="basic-addon1">
                  <i class="ti ti-category fs-6"></i>
                </span>

                <select
                  class="form-control ps-2"
                  name="id_kategori"
                  id="id_kategori"
                >
                  <option value="">Pilih Kategori</option>
                  {
                    dataKategori.map((item: any) => (
                      <option value={item.id}>{item.kategori}</option>
                    ))
                  }
                </select>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Status</label>
              <div class="input-group">
                <span class="input-group-text px-6" id="basic-addon1">
                  <i class="ti ti-upload fs-6"></i>
                </span>

                <select class="form-control ps-2" name="status" id="status">
                  <option value="">Pilih Status</option>
                  <option value="Publish">Publish</option>
                  <option value="Draft">Draft</option>
                </select>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Uplaod Gambar</label>
              <input
                type="file"
                class="form-control ps-2"
                name="gambar"
                id="gambar"
              />
            </div>
            <div class="mb-3">
              <label class="form-label">Artikel</label>
              <div id="editor"></div>
              <input type="hidden" id="artikel" name="artikel" />
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn bg-primary-subtle text-primary waves-effect text-start"
            onclick="simpan(event)"
          >
            Simpan
          </button>
          <button
            type="button"
            class="btn bg-danger-subtle text-danger waves-effect text-start"
            data-bs-dismiss="modal"
          >
            Close
          </button>
        </div>
      </div>
    </div>
  </div>

  <script is:inline>
    let quill;
    document.addEventListener("DOMContentLoaded", function () {
      quill = new Quill("#editor", {
        theme: "snow",
        placeholder: "Tulis konten artikel di sini...",
      });
      const inputCari = document.querySelector('input[name="cari_kategori"]');
      if (inputCari) {
        inputCari.addEventListener("keyup", function () {
          const q = this.value.toLowerCase();
          const rows = document.querySelectorAll("#artikel-table tr");

          rows.forEach((tr) => {
            const textKategori = tr
              .querySelector("td:nth-child(2)")
              .textContent.toLowerCase();

            tr.style.display = textKategori.includes(q) ? "" : "none";
          });
        });
      }

      const perPageSelect = document.getElementById("zero_config_length");
      if (perPageSelect) {
        perPageSelect.addEventListener("change", function () {
          const url = new URL(window.location.href);
          url.searchParams.set("perPage", this.value);
          url.searchParams.set("page", "1"); // balik ke halaman 1
          window.location.href = url.toString();
        });
      }
    });
    function tambah(evt) {
      evt?.preventDefault();
      $("#tambah-artikel").modal("show");
      $("#kategori").val("");
      $("#id_kategori").val("");
      $("#myLargeModalLabel").text("Tambah Artikel");
      if (quill) {
        quill.root.innerHTML = "";
      }
    }

    function edit(detail) {
      const data = JSON.parse(decodeURIComponent(detail));

      $("#judul").val(data.judul);
      $("#id_artikel").val(data.id);
      $("#oldImage").val(data.gambar);
      $("#status").html(`
        <option value="">Pilih Status</option>
                  <option value="Publish" ${data.status == "Publish" ? "selected" : ""}>Publish</option>
                  <option value="Draft" ${data.status == "Draft" ? "selected" : ""}>Draft</option>
        `);
      $("#tambah-artikel").modal("show");
      $("#myLargeModalLabel").text("Edit Artikel");
      if (quill) {
        quill.root.innerHTML = data.artikel || "";
      }
      kategori(data.id_kategori);
    }
    function kategori(id_kategori) {
      $.ajax({
        url: "/controller/kategori",
        method: "GET",
        processData: false,
        contentType: false,
        success: function (data, textStatus, xhr) {
          var option = "";

          data.forEach((item) => {
            var selected = item.id == id_kategori ? "selected" : "";
            option += `<option value="${item.id}" ${selected}>${item.kategori}</option>`;
          });

          $("#id_kategori").html(option);
        },
      });
    }

    function hapus(id) {
      if (!id) return;
      iziToast.question({
        timeout: 20000,
        overlay: true,
        close: true,
        displayMode: "once",
        position: "center",
        title: "Hapus?",
        message: "Yakin ingin hapus data ini?",
        buttons: [
          [
            "<button>Ya</button>",
            function (instance, toast) {
              instance.hide({ transitionOut: "fadeOut" }, toast);
              $.ajax({
                url: `/controller/artikel?id=${encodeURIComponent(id)}`,
                method: "DELETE",
                success: function (_data, textStatus, xhr) {
                  if (xhr.status == 200) {
                    iziToast.success({
                      title: "Berhasil",
                      message: "Data berhasil dihapus",
                      position: "topRight",
                    });
                    setTimeout(() => window.location.reload(), 800);
                  }
                },
                error: function () {
                  iziToast.error({
                    title: "Gagal",
                    message: "Tidak dapat menghapus data",
                    position: "topRight",
                  });
                },
              });
            },
            true,
          ],
          [
            "<button>Batal</button>",
            function (instance, toast) {
              instance.hide({ transitionOut: "fadeOut" }, toast);
            },
          ],
        ],
      });
    }

    function simpan(evt) {
      evt?.preventDefault();

      const html = quill ? quill.root.innerHTML : "";
      console.log(html);
      $("#artikel").val(html);
      const formElement = document.getElementById("form-artikel");
      if (!formElement) return;
      const form = new FormData(formElement);
      $("#tambah-artikel").modal("hide");
      $.ajax({
        url: "/controller/artikel",
        method: "POST",
        data: form,
        processData: false,
        contentType: false,
        success: function (_data, textStatus, xhr) {
          console.log(_data, textStatus, xhr);
          if (xhr.status == 200) {
            iziToast.success({
              title: "Berhasil",
              message: "Data berhasil disimpan",
              position: "topRight",
            });
            setTimeout(() => window.location.reload(), 800);
          }
        },
      });
    }
  </script>
</LayoutBackend>
