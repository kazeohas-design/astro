---
import LayoutBackend from "../../../layout/LayoutBackend.astro";
import { getPagination } from "../../../helper/pagination";
import Pagination from "../../../component/pagination.astro";

const res = await fetch(new URL("/controller/kategori", Astro.request.url), {
  headers: {
    cookie: Astro.request.headers.get("cookie") ?? "",
  },
});

if (!res.ok) {
  return Astro.redirect("/log_profil");
}

const dataKategori = await res.json();
const pagination = getPagination(Astro.url, dataKategori.length, 10);

const paginatedKategori = dataKategori.slice(
  pagination.start,
  pagination.start + pagination.perPage
);
---

<LayoutBackend title="Kategori">
  <div class="card w-100 position-relative overflow-hidden">
    <div
      class="px-4 py-3 border-bottom d-flex justify-content-between align-items-center"
    >
      <h5 class="mb-0">Kategori</h5>

      <div class="d-flex gap-2">
        <button type="button" class="btn btn-primary" onclick="tambah(event)">
          <i class="ti ti-plus"></i> Tambah
        </button>
      </div>
    </div>

    <div class="card-body">
      <div class="row gy-2 align-items-center mb-3">
        <div
          class="col-12 col-md-auto d-flex flex-column flex-sm-row align-items-stretch align-items-sm-center justify-content-center justify-content-md-start gap-2"
        >
          <label for="zero_config_length" class="mb-0 text-nowrap">
            Tampilkan
          </label>
          <select
            name="zero_config_length"
            id="zero_config_length"
            class="form-select flex-grow-1 flex-sm-grow-0"
          >
            <option value="10" selected={pagination.perPage === 10}>10</option>
            <option value="25" selected={pagination.perPage === 25}>25</option>
            <option value="50" selected={pagination.perPage === 50}>50</option>
            <option value="100" selected={pagination.perPage === 100}
              >100</option
            >
          </select>
        </div>

        <div class="col-12 col-md-3 ms-md-auto">
          <input
            type="text"
            name="cari_kategori"
            placeholder="Cari Kategori ..."
            class="form-control w-100"
          />
        </div>
      </div>
      <div class="table-responsive border rounded-4">
        <table class="table text-nowrap mb-0 align-middle" id="page">
          <thead class="bg-primary text-white">
            <tr>
              <th>No</th>
              <th>Kategori</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody id="kategori-table-body">
            {
              (paginatedKategori.length > 0 &&
                paginatedKategori.map((item: any, index: number) => {
                  const no = pagination.start + index;
                  const detail = btoa(JSON.stringify(item));
                  return (
                    <tr>
                      <td>{no + 1}</td>
                      <td>{item.kategori}</td>
                      <td>
                        <button
                          type="button"
                          onclick={`edit('${detail}')`}
                          class="btn btn-primary me-1"
                        >
                          <i class="ti ti-edit fs-5" />
                        </button>
                        <button
                          type="button"
                          class="btn btn-danger"
                          onclick={`hapus(${JSON.stringify(item.id)})`}
                        >
                          <i class="ti ti-trash fs-5" />
                        </button>
                      </td>
                    </tr>
                  );
                })) || (
                <tr>
                  <td colspan="3" class="text-center">
                    Tidak ada data
                  </td>
                </tr>
              )
            }
          </tbody>
        </table>
      </div>
      <Pagination pagination={pagination} />
    </div>
  </div>

  <div
    class="modal fade"
    id="tambah-kategori"
    tabindex="-1"
    aria-labelledby="bs-example-modal-lg"
    aria-hidden="true"
  >
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header d-flex align-items-center">
          <h4 class="modal-title" id="myLargeModalLabel">Tambah Kategori</h4>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="form-kategori">
            <label class="form-label">Kategori</label>
            <div class="input-group">
              <span class="input-group-text px-6" id="basic-addon1">
                <i class="ti ti-category fs-6"></i>
              </span>
              <input
                type="hidden"
                name="id_kategori"
                class="form-control"
                id="id_kategori"
              />
              <input
                type="text"
                class="form-control ps-2"
                name="kategori"
                id="kategori"
                placeholder="Kategori..."
              />
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn bg-primary-subtle text-primary waves-effect text-start"
            onclick="simpan(event)"
          >
            Simpan
          </button>
          <button
            type="button"
            class="btn bg-danger-subtle text-danger waves-effect text-start"
            data-bs-dismiss="modal"
          >
            Close
          </button>
        </div>
      </div>
    </div>
  </div>

  <script is:inline>
    function tambah(evt) {
      evt?.preventDefault();
      $("#tambah-kategori").modal("show");
      $("#kategori").val("");
      $("#id_kategori").val("");
      $("#myLargeModalLabel").text("Tambah Kategori");
    }
    function edit(detail) {
      const data = JSON.parse(atob(detail));

      $("#kategori").val(data.kategori);
      $("#id_kategori").val(data.id);
      $("#tambah-kategori").modal("show");
      $("#myLargeModalLabel").text("Edit Kategori");
    }

    function hapus(id) {
      if (!id) return;
      iziToast.question({
        timeout: 20000,
        overlay: true,
        close: true,
        displayMode: "once",
        position: "center",
        title: "Hapus?",
        message: "Yakin ingin hapus data ini?",
        buttons: [
          [
            "<button>Ya</button>",
            function (instance, toast) {
              instance.hide({ transitionOut: "fadeOut" }, toast);
              $.ajax({
                url: `/controller/kategori?id=${encodeURIComponent(id)}`,
                method: "DELETE",
                success: function (_data, textStatus, xhr) {
                  if (xhr.status == 200) {
                    iziToast.success({
                      title: "Berhasil",
                      message: "Data berhasil dihapus",
                      position: "topRight",
                    });
                    setTimeout(() => window.location.reload(), 800);
                  }
                },
                error: function () {
                  iziToast.error({
                    title: "Gagal",
                    message: "Tidak dapat menghapus data",
                    position: "topRight",
                  });
                },
              });
            },
            true,
          ],
          [
            "<button>Batal</button>",
            function (instance, toast) {
              instance.hide({ transitionOut: "fadeOut" }, toast);
            },
          ],
        ],
      });
    }

    function simpan(evt) {
      evt?.preventDefault();
      const form = $("#form-kategori").serialize();
      $("#tambah-kategori").modal("hide");
      $.ajax({
        url: "/controller/kategori",
        method: "POST",
        data: form,
        success: function (_data, textStatus, xhr) {
          if (xhr.status == 200) {
            iziToast.success({
              title: "Berhasil",
              message: "Data berhasil disimpan",
              position: "topRight",
            });
            setTimeout(() => window.location.reload(), 800);
          }
        },
      });
    }

    document.addEventListener("DOMContentLoaded", function () {
      const inputCari = document.querySelector('input[name="cari_kategori"]');
      if (inputCari) {
        inputCari.addEventListener("keyup", function () {
          const q = this.value.toLowerCase();
          const rows = document.querySelectorAll("#kategori-table-body tr");

          rows.forEach((tr) => {
            const textKategori = tr
              .querySelector("td:nth-child(2)")
              .textContent.toLowerCase();

            tr.style.display = textKategori.includes(q) ? "" : "none";
          });
        });
      }

      // ðŸ”¢ handle dropdown perPage
      const perPageSelect = document.getElementById("zero_config_length");
      if (perPageSelect) {
        perPageSelect.addEventListener("change", function () {
          const url = new URL(window.location.href);
          url.searchParams.set("perPage", this.value);
          url.searchParams.set("page", "1"); // balik ke halaman 1
          window.location.href = url.toString();
        });
      }
    });
  </script>
</LayoutBackend>
